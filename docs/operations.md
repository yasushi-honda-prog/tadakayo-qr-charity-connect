# 運用ガイド

## 運用の前提
- 決済は PayPay for Developers / 楽天ペイ API を使用する
- Cloud Run + Firestore + Secret Manager + Cloud NAT を前提とする
- Webhookの署名検証と重複排除（idempotency）は必須

## 日次・週次オペレーション
- 決済件数をプロバイダ管理画面とFirestoreで突合
- 失敗/返金イベントの件数を確認し、異常があれば原因を特定
- 寄付者からの問い合わせに備え、決済IDと寄付記録の紐付けを確認

## Webhook運用

### 受信時の必須チェック
1. リクエスト署名の検証
2. 既知イベントの判定（payment.completed / failed / refunded など）
3. 既処理判定（決済ID + イベントIDで重複排除）

### 失敗時の取り扱い
- 署名不一致: 401を返し、監視に通知
- 不正なペイロード: 400を返し、ログに詳細を残す
- 一時障害: 500を返し、プロバイダ側の再送に備える

### 再送・再処理
- 再送が来た場合でも idempotent に処理
- 手動再処理は、Firestoreのステータスを基準に再計算

## 監視とアラート
- Webhook 4xx/5xx 率の急上昇をアラート
- 署名検証失敗率が一定以上になったら即通知
- 決済成功率が異常に低下した場合は運用連絡

## セキュリティ運用
- APIキー/署名鍵は Secret Manager で管理し、ログ出力禁止
- WebhookのIP制限が可能な場合はホワイトリスト化
- PII（氏名/メール/電話番号など）はログに残さない

## 寄付者対応
- Firestoreの寄付記録から決済IDで検索できるようにする
- 領収書の発行フローは、寄付者からの依頼時に対応

## コスト管理
- Cloud NATの固定費 + 通信量の増減を月次で確認
- 決済手数料はプロバイダ管理画面の明細で確認

## 障害時の一次対応
- 決済API障害: 寄付ボタンを停止し、ステータスページに誘導
- Webhook障害: 再送で復旧するまでロールバックせず、ログで追跡

## 参考リンク
- [PayPay for Developers](https://paypay.ne.jp/store-online/)
- [楽天ペイ（オンライン決済）](https://checkout.rakuten.co.jp/biz/)
