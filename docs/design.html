<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¿ãƒ€ã‚«ãƒ¨ QRãƒãƒ£ãƒªãƒ†ã‚£ãƒ»ã‚³ãƒã‚¯ãƒˆ - è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #10b981;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Hiragino Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.7;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 60px 0;
            text-align: center;
        }
        header h1 {
            font-size: 2.5rem;
            margin-bottom: 16px;
        }
        header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        .badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-top: 16px;
        }
        nav {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        nav ul {
            display: flex;
            list-style: none;
            gap: 8px;
            padding: 16px 0;
            overflow-x: auto;
            flex-wrap: wrap;
            justify-content: center;
        }
        nav a {
            color: var(--text);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            white-space: nowrap;
            transition: background 0.2s;
        }
        nav a:hover {
            background: var(--bg);
        }
        section {
            padding: 60px 0;
            border-bottom: 1px solid var(--border);
        }
        section:last-child {
            border-bottom: none;
        }
        h2 {
            font-size: 1.8rem;
            margin-bottom: 24px;
            color: var(--primary);
        }
        h3 {
            font-size: 1.3rem;
            margin: 32px 0 16px;
            color: var(--text);
        }
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            margin: 24px 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .mermaid {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            margin: 24px 0;
            overflow-x: auto;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 24px 0;
        }
        .feature-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .feature-card h4 {
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: var(--primary);
        }
        .feature-card p {
            color: var(--text-light);
            font-size: 0.95rem;
        }
        .tech-stack {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin: 16px 0;
        }
        .tech-tag {
            background: #e0e7ff;
            color: var(--primary);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        .status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .status-done { background: #d1fae5; color: #065f46; }
        .status-progress { background: #fef3c7; color: #92400e; }
        .status-pending { background: #e2e8f0; color: #475569; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
        }
        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        th {
            background: var(--bg);
            font-weight: 600;
        }
        code {
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.9em;
        }
        .note {
            background: #fffbeb;
            border-left: 4px solid #f59e0b;
            padding: 16px;
            border-radius: 0 8px 8px 0;
            margin: 16px 0;
        }
        .ai-tip {
            background: #f0fdf4;
            border-left: 4px solid var(--secondary);
            padding: 16px;
            border-radius: 0 8px 8px 0;
            margin: 16px 0;
        }
        .ai-tip h4 {
            color: var(--secondary);
            margin-bottom: 8px;
        }
        footer {
            background: var(--text);
            color: white;
            padding: 40px 0;
            text-align: center;
        }
        footer a {
            color: #93c5fd;
        }
        @media (max-width: 768px) {
            header h1 { font-size: 1.8rem; }
            h2 { font-size: 1.5rem; }
            nav ul { justify-content: flex-start; }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 20px;">
                <img src="assets/tadakayo-logo.jpg" alt="ã‚¿ãƒ€ã‚«ãƒ¨" style="width: 80px; height: 80px; border-radius: 16px; background: white;">
                <div>
                    <h1>ã‚¿ãƒ€ã‚«ãƒ¨ QRãƒãƒ£ãƒªãƒ†ã‚£ãƒ»ã‚³ãƒã‚¯ãƒˆ</h1>
                    <p>QRã‚¹ã‚­ãƒ£ãƒ³â†’PayPayæ±ºæ¸ˆã®æœ€çŸ­ãƒ•ãƒ­ãƒ¼ã§æ”¯æ´ã‚’å®Ÿç¾</p>
                </div>
            </div>
            <span class="badge">GCP Serverless Architecture</span>
            <span class="badge" style="background: #fef3c7; color: #92400e; margin-left: 8px;">ãƒ‡ãƒ¢ç‰ˆå…¬é–‹ä¸­</span>
            <div style="margin-top: 24px;">
                <a href="https://qr-payment-api-sandbox-yggvw3tpqa-an.a.run.app/donate" target="_blank"
                   style="display: inline-block; background: white; color: var(--primary); padding: 12px 32px; border-radius: 8px; text-decoration: none; font-weight: 600; transition: transform 0.2s;">
                    ãƒ‡ãƒ¢ç‰ˆã‚’è©¦ã™ â†’
                </a>
            </div>
        </div>
    </header>

    <nav>
        <div class="container">
            <ul>
                <li><a href="#overview">æ¦‚è¦</a></li>
                <li><a href="#architecture">ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£</a></li>
                <li><a href="#donation-flow">æ”¯æ´ãƒ•ãƒ­ãƒ¼</a></li>
                <li><a href="#webhook">Webhookå‡¦ç†</a></li>
                <li><a href="#data-model">ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«</a></li>
                <li><a href="#infrastructure">ã‚¤ãƒ³ãƒ•ãƒ©æ§‹æˆ</a></li>
                <li><a href="#dev-flow">é–‹ç™ºãƒ•ãƒ­ãƒ¼</a></li>
                <li><a href="#roadmap">ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—</a></li>
                <li><a href="#ai-guide">AIé–‹ç™ºã‚¬ã‚¤ãƒ‰</a></li>
            </ul>
        </div>
    </nav>

    <main>
        <!-- æ¦‚è¦ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <section id="overview">
            <div class="container">
                <h2>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦</h2>
                <p>æœ¬ã‚·ã‚¹ãƒ†ãƒ ã¯ã€NPOæ³•äººã‚¿ãƒ€ã‚«ãƒ¨ã®æ´»å‹•ã‚’æ”¯æ´ã™ã‚‹ãŸã‚ã®æ±ºæ¸ˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã™ã€‚<strong>å›ºå®šé‡‘é¡ã®QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ã ã‘ã§ã€PayPayæ±ºæ¸ˆãƒšãƒ¼ã‚¸ã«ç›´æ¥é·ç§»</strong>ã€‚æœ€çŸ­2ã‚¿ãƒƒãƒ—ã§æ”¯æ´ãŒå®Œäº†ã—ã¾ã™ã€‚ãƒãƒ©ã‚·ãƒ»ååˆºãƒ»ã‚¤ãƒ™ãƒ³ãƒˆæŠ•å½±ã«å°åˆ·ã—ã¦ã€æ”¯æ´ã¸ã®å°ç·šã‚’æœ€å¤§åŒ–ã§ãã¾ã™ã€‚</p>

                <div class="note" style="background: #f0fdf4; border-left-color: #10b981;">
                    <strong>é‡è¦ï¼šå¯¾ä¾¡æ€§ã®ã‚ã‚‹å–å¼•ï¼ˆå£²ä¸Šï¼‰</strong><br>
                    ã‚¿ãƒ€ã‚«ãƒ¨ã®ã€Œæ”¯æ´ã€ã¯ã€ç ”ä¿®ã®æä¾›ã‚„ã‚°ãƒƒã‚ºã®æä¾›ãªã©<strong>å¯¾ä¾¡æ€§ã®ã‚ã‚‹å–å¼•</strong>ã§ã‚ã‚Šã€çµŒç†ä¸Šã¯ã€Œå£²ä¸Šã€ã¨ã—ã¦è¨ˆä¸Šã—ã¾ã™ã€‚ã“ã®ä½ç½®ã¥ã‘ã«ã‚ˆã‚Šã€PayPay for Developers / æ¥½å¤©ãƒšã‚¤ã¯<strong>å•†å–å¼•ç”¨é€”</strong>ã¨ã—ã¦é©åˆã—ã¾ã™ã€‚
                </div>

                <div class="grid">
                    <div class="feature-card">
                        <h4>ğŸ“± QRã‚³ãƒ¼ãƒ‰â†’å³æ±ºæ¸ˆ</h4>
                        <p>é‡‘é¡ä»˜ãQRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³â†’PayPayã§å³æ±ºæ¸ˆã€‚æœ€çŸ­2ã‚¿ãƒƒãƒ—ã§æ”¯æ´å®Œäº†ã€‚</p>
                    </div>
                    <div class="feature-card">
                        <h4>ğŸ¯ å›ºå®šé‡‘é¡QRã‚³ãƒ¼ãƒ‰</h4>
                        <p>500å††/1,000å††/3,000å††/5,000å††ã®QRã‚³ãƒ¼ãƒ‰ã‚’ç™ºè¡Œã€‚ãƒãƒ©ã‚·ãƒ»ååˆºã«æœ€é©ã€‚</p>
                    </div>
                    <div class="feature-card">
                        <h4>ğŸ“Š æµå…¥å…ƒãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°</h4>
                        <p>ãƒãƒ©ã‚·ãƒ»ååˆºãƒ»ã‚¤ãƒ™ãƒ³ãƒˆã”ã¨ã®åŠ¹æœæ¸¬å®šã§ã€ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æ”¹å–„ã«æ´»ç”¨ã€‚</p>
                    </div>
                    <div class="feature-card">
                        <h4>ğŸ’° ä½ã‚³ã‚¹ãƒˆé‹ç”¨</h4>
                        <p>GCPã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹æ§‹æˆã«ã‚ˆã‚‹å¾“é‡èª²é‡‘ã€‚ã‚¢ã‚¯ã‚»ã‚¹ãŒãªã„æ™‚ã¯èª²é‡‘ã‚¼ãƒ­ã€‚</p>
                    </div>
                </div>

                <h3>æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯</h3>
                <div class="tech-stack">
                    <span class="tech-tag">Cloud Run</span>
                    <span class="tech-tag">Cloud Firestore</span>
                    <span class="tech-tag">Secret Manager</span>
                    <span class="tech-tag">Cloud NAT</span>
                    <span class="tech-tag">Terraform</span>
                    <span class="tech-tag">Node.js / Python</span>
                    <span class="tech-tag">PayPay API</span>
                    <span class="tech-tag">æ¥½å¤©ãƒšã‚¤ API</span>
                </div>
            </div>
        </section>

        <!-- ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <section id="architecture">
            <div class="container">
                <h2>ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£</h2>
                <p>GCPã®ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹è£½å“ç¾¤ã‚’æ´»ç”¨ã—ã€ä½ã‚³ã‚¹ãƒˆãƒ»é«˜ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»é«˜æ‹¡å¼µæ€§ã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚</p>

                <div class="mermaid">
graph TB
    subgraph "Physical World"
        QR1[ãƒãƒ©ã‚· QR]
        QR2[ååˆº QR]
        QR3[ã‚¤ãƒ™ãƒ³ãƒˆæŠ•å½± QR]
    end

    subgraph "User"
        Phone[ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³]
    end

    subgraph "GCP: tadakayo-qr-connect"
        subgraph "Compute"
            CR[Cloud Run<br/>Backend Service]
        end

        subgraph "Data"
            FS[(Firestore<br/>æ”¯æ´è¨˜éŒ²)]
            SM[Secret Manager<br/>APIã‚­ãƒ¼/ç½²åéµ]
        end

        subgraph "Network"
            NAT[Cloud NAT<br/>å›ºå®šIP]
            VPC[VPC Network]
        end
    end

    subgraph "External Payment APIs"
        PP[PayPay API]
        RP[æ¥½å¤©ãƒšã‚¤ API]
    end

    QR1 & QR2 & QR3 -->|ã‚¹ã‚­ãƒ£ãƒ³| Phone
    Phone -->|HTTPS| CR
    CR -->|èª­ã¿æ›¸ã| FS
    CR -->|å–å¾—| SM
    CR --> VPC --> NAT
    NAT -->|API Call| PP & RP
    PP & RP -->|Webhook| CR
                </div>

                <div class="ai-tip">
                    <h4>AIé–‹ç™ºã®ãƒã‚¤ãƒ³ãƒˆ</h4>
                    <p>ã“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³ã‚’å‚ç…§ã—ã¦ã€å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé–“ã®ä¾å­˜é–¢ä¿‚ã‚’æŠŠæ¡ã—ã¦ãã ã•ã„ã€‚æ–°æ©Ÿèƒ½è¿½åŠ æ™‚ã¯ã€å½±éŸ¿ã‚’å—ã‘ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ç‰¹å®šã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚</p>
                </div>
            </div>
        </section>

        <!-- æ”¯æ´ãƒ•ãƒ­ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <section id="donation-flow">
            <div class="container">
                <h2>æ”¯æ´ãƒ•ãƒ­ãƒ¼ï¼ˆã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ï¼‰</h2>
                <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒQRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ã‹ã‚‰æ”¯æ´æ±ºæ¸ˆãŒå®Œäº†ã™ã‚‹ã¾ã§ã®æµã‚Œã§ã™ã€‚</p>

                <div class="mermaid">
sequenceDiagram
    autonumber
    participant U as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant QR as QRã‚³ãƒ¼ãƒ‰
    participant CR as Cloud Run
    participant SM as Secret Manager
    participant FS as Firestore
    participant PP as PayPay/æ¥½å¤©ãƒšã‚¤

    U->>QR: QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³
    QR->>CR: GET /donate?source=flyer_001
    CR->>FS: æµå…¥å…ƒã‚’è¨˜éŒ²
    CR->>U: é‡‘é¡é¸æŠãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º
    U->>CR: é‡‘é¡ã‚’é¸æŠ (ä¾‹: 1,000å††)
    CR->>SM: APIã‚­ãƒ¼ã‚’å–å¾—
    SM-->>CR: APIã‚­ãƒ¼
    CR->>PP: æ±ºæ¸ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆ
    PP-->>CR: æ±ºæ¸ˆURL
    CR->>U: æ±ºæ¸ˆç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    U->>PP: æ±ºæ¸ˆã‚’å®Ÿè¡Œ
    PP-->>U: æ±ºæ¸ˆå®Œäº†
    PP->>CR: Webhooké€šçŸ¥
    CR->>SM: ç½²åæ¤œè¨¼éµã‚’å–å¾—
    SM-->>CR: ç½²åéµ
    CR->>CR: ç½²åæ¤œè¨¼
    CR->>FS: æ±ºæ¸ˆçµæœã‚’ä¿å­˜
    CR->>U: ã‚µãƒ³ã‚¯ã‚¹ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º
                </div>

                <div class="note">
                    <strong>é‡è¦:</strong> ã‚¹ãƒ†ãƒƒãƒ—14-15ã®ç½²åæ¤œè¨¼ã¯å¿…é ˆã§ã™ã€‚ã“ã‚Œã‚’çœç•¥ã™ã‚‹ã¨ã€ä¸æ­£ãªWebhooké€šçŸ¥ã‚’å—ã‘å…¥ã‚Œã‚‹ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚
                </div>
            </div>
        </section>

        <!-- Webhookå‡¦ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <section id="webhook">
            <div class="container">
                <h2>Webhookå‡¦ç†ãƒ•ãƒ­ãƒ¼</h2>
                <p>æ±ºæ¸ˆãƒ—ãƒ­ãƒã‚¤ãƒ€ã‹ã‚‰ã®Webhooké€šçŸ¥ã‚’å®‰å…¨ã«å‡¦ç†ã™ã‚‹ãƒ•ãƒ­ãƒ¼ã§ã™ã€‚</p>

                <div class="mermaid">
flowchart TD
    A[Webhookå—ä¿¡] --> B{ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ¤œè¨¼}
    B -->|ç„¡åŠ¹| C[400 Bad Request]
    B -->|æœ‰åŠ¹| D[ç½²åæ¤œè¨¼]
    D -->|å¤±æ•—| E[401 Unauthorized]
    D -->|æˆåŠŸ| F{ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—åˆ¤å®š}

    F -->|payment.completed| G[æ±ºæ¸ˆå®Œäº†å‡¦ç†]
    F -->|payment.failed| H[æ±ºæ¸ˆå¤±æ•—å‡¦ç†]
    F -->|payment.refunded| I[è¿”é‡‘å‡¦ç†]
    F -->|unknown| J[ãƒ­ã‚°è¨˜éŒ²ã®ã¿]

    G --> K[Firestoreã«ä¿å­˜]
    H --> K
    I --> K
    J --> L[200 OK]
    K --> L

    subgraph "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯"
        B
        D
    end

    subgraph "ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯"
        F
        G
        H
        I
        J
    end
                </div>

                <h3>ç½²åæ¤œè¨¼ã®å®Ÿè£…ä¾‹</h3>
                <div class="card">
                    <code>
// Node.js ã§ã®ç½²åæ¤œè¨¼ä¾‹<br>
const crypto = require('crypto');<br><br>
function verifySignature(payload, signature, secret) {<br>
&nbsp;&nbsp;const expected = crypto<br>
&nbsp;&nbsp;&nbsp;&nbsp;.createHmac('sha256', secret)<br>
&nbsp;&nbsp;&nbsp;&nbsp;.update(payload)<br>
&nbsp;&nbsp;&nbsp;&nbsp;.digest('hex');<br>
&nbsp;&nbsp;return crypto.timingSafeEqual(<br>
&nbsp;&nbsp;&nbsp;&nbsp;Buffer.from(signature),<br>
&nbsp;&nbsp;&nbsp;&nbsp;Buffer.from(expected)<br>
&nbsp;&nbsp;);<br>
}
                    </code>
                </div>

                <div class="ai-tip">
                    <h4>AIé–‹ç™ºã®ãƒã‚¤ãƒ³ãƒˆ</h4>
                    <p>Webhookå‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹éš›ã¯ã€ã“ã®ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã«å¾“ã£ã¦å…¨ã¦ã®ãƒ‘ã‚¹ã‚’ç¶²ç¾…ã—ã¦ãã ã•ã„ã€‚ç‰¹ã«ç½²åæ¤œè¨¼ã®å¤±æ•—ã‚±ãƒ¼ã‚¹ã¨unknownã‚¤ãƒ™ãƒ³ãƒˆã®å‡¦ç†ã‚’å¿˜ã‚Œãšã«ã€‚</p>
                </div>
            </div>
        </section>

        <!-- ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <section id="data-model">
            <div class="container">
                <h2>ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«</h2>
                <p>Firestoreï¼ˆNoSQLï¼‰ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³æ§‹é€ ã§ã™ã€‚</p>

                <div class="mermaid">
erDiagram
    donations {
        string id PK "è‡ªå‹•ç”ŸæˆID"
        string source "æµå…¥å…ƒ(flyer_001ç­‰)"
        int amount "æ”¯æ´é‡‘é¡"
        string currency "é€šè²¨(JPY)"
        string payment_provider "æ±ºæ¸ˆãƒ—ãƒ­ãƒã‚¤ãƒ€"
        string payment_id "æ±ºæ¸ˆãƒ—ãƒ­ãƒã‚¤ãƒ€ã®ID"
        string status "pending/completed/failed/refunded"
        timestamp created_at "ä½œæˆæ—¥æ™‚"
        timestamp updated_at "æ›´æ–°æ—¥æ™‚"
    }

    qr_sources {
        string id PK "QRã‚½ãƒ¼ã‚¹ID(flyer_001ç­‰)"
        string name "è¡¨ç¤ºå"
        string type "flyer/card/event"
        string description "èª¬æ˜"
        boolean active "æœ‰åŠ¹ãƒ•ãƒ©ã‚°"
        timestamp created_at "ä½œæˆæ—¥æ™‚"
    }

    webhook_logs {
        string id PK "è‡ªå‹•ç”ŸæˆID"
        string provider "PayPay/RakutenPay"
        string event_type "ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—"
        string payment_id "é–¢é€£ã™ã‚‹æ±ºæ¸ˆID"
        object raw_payload "ç”Ÿã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰"
        boolean signature_valid "ç½²åæ¤œè¨¼çµæœ"
        timestamp received_at "å—ä¿¡æ—¥æ™‚"
    }

    donations ||--o{ webhook_logs : "payment_id"
    qr_sources ||--o{ donations : "source"
                </div>

                <h3>ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³è©³ç´°</h3>
                <table>
                    <tr>
                        <th>ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</th>
                        <th>ç”¨é€”</th>
                        <th>ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹</th>
                    </tr>
                    <tr>
                        <td><code>donations</code></td>
                        <td>æ”¯æ´è¨˜éŒ²ã®ä¿å­˜</td>
                        <td>source, status, created_at</td>
                    </tr>
                    <tr>
                        <td><code>qr_sources</code></td>
                        <td>QRã‚³ãƒ¼ãƒ‰æµå…¥å…ƒã®ç®¡ç†</td>
                        <td>type, active</td>
                    </tr>
                    <tr>
                        <td><code>webhook_logs</code></td>
                        <td>Webhooké€šçŸ¥ã®ãƒ­ã‚°ï¼ˆç›£æŸ»ç”¨ï¼‰</td>
                        <td>provider, received_at</td>
                    </tr>
                </table>
            </div>
        </section>

        <!-- ã‚¤ãƒ³ãƒ•ãƒ©æ§‹æˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <section id="infrastructure">
            <div class="container">
                <h2>ã‚¤ãƒ³ãƒ•ãƒ©æ§‹æˆï¼ˆGCPï¼‰</h2>
                <p>Terraformã§ç®¡ç†ã™ã‚‹GCPãƒªã‚½ãƒ¼ã‚¹ã®æ§‹æˆã§ã™ã€‚</p>

                <div class="mermaid">
graph TB
    subgraph "GCP Project: tadakayo-qr-connect"
        subgraph "IAM"
            SA[Service Account<br/>cloud-run-sa]
        end

        subgraph "Networking"
            VPC[VPC Network<br/>donation-vpc]
            SUBNET[Subnet<br/>asia-northeast1]
            ROUTER[Cloud Router]
            NAT[Cloud NAT<br/>å›ºå®šIP: x.x.x.x]
            VPC --> SUBNET
            SUBNET --> ROUTER --> NAT
        end

        subgraph "Serverless"
            CR[Cloud Run<br/>donation-api]
            CR -.->|VPC Connector| VPC
        end

        subgraph "Data & Security"
            FS[(Firestore<br/>Native Mode)]
            SM[Secret Manager]
        end

        subgraph "Observability"
            LOG[Cloud Logging]
            MON[Cloud Monitoring]
            ERR[Error Reporting]
        end

        SA -->|æ¨©é™| CR
        SA -->|æ¨©é™| FS
        SA -->|æ¨©é™| SM
        CR --> LOG
        LOG --> MON
        LOG --> ERR
    end

    EXT[External<br/>Payment APIs] -->|Webhook| CR
    NAT -->|API Call| EXT
                </div>

                <h3>å›ºå®šIPãŒå¿…è¦ãªç†ç”±</h3>
                <div class="card">
                    <p>PayPayã‚„æ¥½å¤©ãƒšã‚¤ã®APIã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚æ¥ç¶šå…ƒIPã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆç™»éŒ²ã‚’æ±‚ã‚ã¦ã„ã¾ã™ã€‚Cloud NATã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ç’°å¢ƒã§ã‚‚å›ºå®šIPã‹ã‚‰ã®é€šä¿¡ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚</p>
                </div>
            </div>
        </section>

        <!-- é–‹ç™ºãƒ•ãƒ­ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <section id="dev-flow">
            <div class="container">
                <h2>é–‹ç™ºãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼</h2>
                <p>GitHubã¨GCPã‚’é€£æºã—ãŸCI/CDãƒ•ãƒ­ãƒ¼ã§ã™ã€‚</p>

                <div class="mermaid">
flowchart LR
    subgraph "Local Development"
        DEV[é–‹ç™ºè€…]
        CODE[ã‚³ãƒ¼ãƒ‰å¤‰æ›´]
        TEST[ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆ]
    end

    subgraph "GitHub"
        PR[Pull Request]
        REVIEW[ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼]
        MAIN[main branch]
    end

    subgraph "CI/CD"
        CI[GitHub Actions<br/>Lint & Test]
        BUILD[Docker Build]
        DEPLOY[Cloud Run Deploy]
    end

    subgraph "GCP"
        STG[Stagingç’°å¢ƒ]
        PROD[Productionç’°å¢ƒ]
    end

    DEV --> CODE --> TEST --> PR
    PR --> CI
    CI -->|Pass| REVIEW
    CI -->|Fail| DEV
    REVIEW -->|Approve| MAIN
    MAIN --> BUILD --> DEPLOY
    DEPLOY --> STG
    STG -->|Manual Approval| PROD
                </div>

                <h3>ãƒ–ãƒ©ãƒ³ãƒæˆ¦ç•¥</h3>
                <div class="mermaid">
gitGraph
    commit id: "initial"
    branch feature/payment-api
    checkout feature/payment-api
    commit id: "add PayPay"
    commit id: "add webhook"
    checkout main
    merge feature/payment-api id: "PR #1"
    branch feature/tracking
    checkout feature/tracking
    commit id: "add source tracking"
    checkout main
    merge feature/tracking id: "PR #2"
    commit id: "release v1.0"
                </div>
            </div>
        </section>

        <!-- ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <section id="roadmap">
            <div class="container">
                <h2>é–‹ç™ºãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—</h2>

                <div class="note" style="background: #f0fdf4; border-left-color: #10b981; margin-bottom: 24px;">
                    <strong>ğŸ‰ ãƒ‡ãƒ¢ç‰ˆå…¬é–‹ä¸­ï¼</strong><br>
                    PayPay SDK Sandboxæ¥ç¶šç¢ºèªæ¸ˆã¿ã€‚QRã‚³ãƒ¼ãƒ‰æ±ºæ¸ˆã®å®Œå…¨ãªãƒ•ãƒ­ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆã§ãã¾ã™ã€‚<br>
                    <strong>æœ€æ–°æ›´æ–°</strong>ï¼ˆ2026/01/25ï¼‰: UIã‚’QRã‚³ãƒ¼ãƒ‰æ±ºæ¸ˆä¸­å¿ƒã«åˆ·æ–°<br>
                    <div style="margin-top: 12px;">
                        <a href="https://qr-payment-api-sandbox-yggvw3tpqa-an.a.run.app/donate" target="_blank" style="color: #10b981; font-weight: 600; margin-right: 16px;">æ”¯æ´ãƒšãƒ¼ã‚¸ â†’</a>
                        <a href="https://qr-payment-api-sandbox-yggvw3tpqa-an.a.run.app/qr/500" target="_blank" style="color: #10b981; font-weight: 600;">500å††QRã‚³ãƒ¼ãƒ‰ â†’</a>
                    </div>
                </div>

                <h3>ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³è©³ç´°</h3>
                <table>
                    <tr>
                        <th>ãƒ•ã‚§ãƒ¼ã‚º</th>
                        <th>ç›®æ¨™</th>
                        <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                    </tr>
                    <tr>
                        <td>ç¬¬1æ®µéš: å¥‘ç´„ãƒ»æº–å‚™</td>
                        <td>æ±ºæ¸ˆãƒ—ãƒ­ãƒã‚¤ãƒ€ã¸ã®ç”³è«‹ãƒ»å¥‘ç´„</td>
                        <td><span class="status status-progress">ç”³è«‹æº–å‚™ä¸­</span></td>
                    </tr>
                    <tr>
                        <td>ç¬¬2æ®µéš: ã‚¤ãƒ³ãƒ•ãƒ©æ•´å‚™</td>
                        <td>GCPåŸºç›¤æ§‹ç¯‰ï¼ˆCloud Run / Firestore / NATï¼‰</td>
                        <td><span class="status status-done">å®Œäº†</span></td>
                    </tr>
                    <tr>
                        <td>ç¬¬3æ®µéš: MVPå®Ÿè£…</td>
                        <td>æ”¯æ´ãƒšãƒ¼ã‚¸ã€æ±ºæ¸ˆAPIé€£æºã€Webhookã€å›ºå®šé‡‘é¡QRã‚³ãƒ¼ãƒ‰</td>
                        <td><span class="status status-done">Sandboxæ¥ç¶šæ¸ˆã¿</span></td>
                    </tr>
                    <tr>
                        <td>ç¬¬4æ®µéš: è¤‡æ•°æ±ºæ¸ˆ</td>
                        <td>PayPayãƒ»æ¥½å¤©ãƒšã‚¤ä¸¡å¯¾å¿œ</td>
                        <td><span class="status status-done">ãƒ¢ãƒƒã‚¯ç‰ˆå®Œäº†</span></td>
                    </tr>
                    <tr>
                        <td>ç¬¬5æ®µéš: é‹ç”¨ãƒ»åˆ†æ</td>
                        <td>GA4ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã€æ±ºæ¸ˆæˆåŠŸç‡ã®å¯è¦–åŒ–</td>
                        <td><span class="status status-pending">äºˆå®š</span></td>
                    </tr>
                </table>

                <h3>æ§‹ç¯‰æ¸ˆã¿ãƒªã‚½ãƒ¼ã‚¹</h3>
                <div class="card">
                    <table>
                        <tr>
                            <th>ãƒªã‚½ãƒ¼ã‚¹</th>
                            <th>è©³ç´°</th>
                        </tr>
                        <tr>
                            <td>Cloud Run</td>
                            <td><code>qr-payment-api-sandbox</code> - ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿</td>
                        </tr>
                        <tr>
                            <td>Cloud NAT</td>
                            <td>å›ºå®šIP: <code>34.84.72.66</code></td>
                        </tr>
                        <tr>
                            <td>Terraform</td>
                            <td><code>infrastructure/environments/sandbox/</code></td>
                        </tr>
                        <tr>
                            <td>CI/CD</td>
                            <td>GitHub Actionsï¼ˆè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰</td>
                        </tr>
                    </table>
                </div>

                <h3>æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</h3>
                <div class="card">
                    <ul style="padding-left: 24px;">
                        <li><strong>PayPay for Developers</strong> ã¸ã®å•†å–å¼•ç”³è«‹</li>
                        <li><strong>æ¥½å¤©ãƒšã‚¤ï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ±ºæ¸ˆï¼‰</strong> ã¸ã®å•†å–å¼•ç”³è«‹</li>
                        <li>å¯©æŸ»é€šéå¾Œã€æœ¬ç•ªç”¨APIã‚­ãƒ¼ã‚’è¨­å®š</li>
                        <li>æ­£å¼ç‰ˆå…¬é–‹ã€QRã‚³ãƒ¼ãƒ‰ç™ºè¡Œ</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- AIé–‹ç™ºã‚¬ã‚¤ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <section id="ai-guide">
            <div class="container">
                <h2>AIé§†å‹•é–‹ç™ºã‚¬ã‚¤ãƒ‰</h2>
                <p>Claude Codeãªã©ã®AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã¨å”åƒã™ã‚‹éš›ã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã§ã™ã€‚</p>

                <h3>ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå…±æœ‰ç”¨ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h3>
                <div class="card">
                    <p>AIã«ä½œæ¥­ã‚’ä¾é ¼ã™ã‚‹éš›ã¯ã€ä»¥ä¸‹ã®æƒ…å ±ã‚’æä¾›ã—ã¦ãã ã•ã„ï¼š</p>
                    <ul style="margin-top: 12px; padding-left: 24px;">
                        <li>å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«/ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ</li>
                        <li>æœŸå¾…ã™ã‚‹å‹•ä½œï¼ˆå—ã‘å…¥ã‚Œæ¡ä»¶ï¼‰</li>
                        <li>é–¢é€£ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆã“ã®ãƒšãƒ¼ã‚¸ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰</li>
                        <li>åˆ¶ç´„äº‹é …ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç­‰ï¼‰</li>
                    </ul>
                </div>

                <h3>é‡è¦ãªè¨­è¨ˆæ±ºå®šï¼ˆADRï¼‰</h3>
                <div class="mermaid">
mindmap
    root((è¨­è¨ˆæ±ºå®š))
        ADR-001
            Cloud Runæ¡ç”¨
            ã‚ªãƒ¼ãƒˆã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
            å¾“é‡èª²é‡‘
        ADR-002
            Cloud NAT
            å›ºå®šIP
            æ±ºæ¸ˆAPIå¯¾å¿œ
        ADR-003
            Firestore
            ã‚¹ã‚­ãƒ¼ãƒãƒ¬ã‚¹
            æ‹¡å¼µæ€§é‡è¦–
                </div>

                <h3>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h3>
                <div class="card">
                    <table>
                        <tr>
                            <th>é …ç›®</th>
                            <th>ç¢ºèªäº‹é …</th>
                        </tr>
                        <tr>
                            <td>ç½²åæ¤œè¨¼</td>
                            <td>Webhooké€šçŸ¥ã®ç½²åã‚’å¿…ãšæ¤œè¨¼</td>
                        </tr>
                        <tr>
                            <td>ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†</td>
                            <td>APIã‚­ãƒ¼/ç½²åéµã¯Secret Managerã§ç®¡ç†</td>
                        </tr>
                        <tr>
                            <td>ãƒ­ã‚°å‡ºåŠ›</td>
                            <td>APIã‚­ãƒ¼ã€ç½²åéµã€PIIã‚’ãƒ­ã‚°ã«å‡ºåŠ›ã—ãªã„</td>
                        </tr>
                        <tr>
                            <td>å…¥åŠ›æ¤œè¨¼</td>
                            <td>é‡‘é¡ã€sourceç­‰ã®å…¥åŠ›å€¤ã‚’æ¤œè¨¼</td>
                        </tr>
                        <tr>
                            <td>è¦ç´„é©åˆæ€§</td>
                            <td>å•†å–å¼•ã¨ã—ã¦ç”³è«‹ï¼ˆå¯¾ä¾¡æ€§ã®ã‚ã‚‹å–å¼•ï¼‰</td>
                        </tr>
                    </table>
                </div>

                <div class="ai-tip">
                    <h4>AIã¸ã®ä¾é ¼ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h4>
                    <p><strong>ç›®çš„:</strong> [ä½•ã‚’é”æˆã—ãŸã„ã‹]<br>
                    <strong>å¯¾è±¡:</strong> [å¤‰æ›´ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«/ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ]<br>
                    <strong>åˆ¶ç´„:</strong> [å®ˆã‚‹ã¹ããƒ«ãƒ¼ãƒ«]<br>
                    <strong>å—ã‘å…¥ã‚Œæ¡ä»¶:</strong> [å®Œäº†ã®å®šç¾©]</p>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>ã‚¿ãƒ€ã‚«ãƒ¨ QRãƒãƒ£ãƒªãƒ†ã‚£ãƒ»ã‚³ãƒã‚¯ãƒˆ</p>
            <p style="margin-top: 8px; opacity: 0.8;">
                <a href="index.html">ç´¹ä»‹ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹</a> |
                <a href="https://mmky310.info/" target="_blank">ã‚¿ãƒ€ã‚«ãƒ¨å…¬å¼ã‚µã‚¤ãƒˆ</a> |
                <a href="https://github.com/yasushi-honda-prog/tadakayo-qr-charity-connect">GitHub Repository</a>
            </p>
            <p style="margin-top: 16px; font-size: 0.85rem; opacity: 0.6;">
                Built with AI-Driven Development
            </p>
        </div>
    </footer>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose',
            flowchart: { useMaxWidth: true },
            sequence: { useMaxWidth: true },
            gantt: { useMaxWidth: true }
        });
    </script>
</body>
</html>
