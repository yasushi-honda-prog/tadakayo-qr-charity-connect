# ADR-004: 決済プロバイダ選定 - PayPay/Rakuten API連携

## Status
Accepted

## Context

タダカヨ QRチャリティ・コネクトでは、QRコードを起点としたPayPay/楽天ペイでの支援決済を実現する。

### 重要な前提：対価性のある取引（売上）

タダカヨの「支援」は、研修の提供やグッズの提供など**対価性のある取引**であり、経理上は「売上」として計上する。これは現在の出張タダスク後の支援金も同様の扱いである。

この位置づけにより：
- **PayPay for Developers / 楽天ペイは商取引用途**であり、本システムの用途に適合する
- 「寄付」としての規約適合性の懸念は該当しない

### 検討経緯

以前は「つながる募金」を検討していたが、**新規受付停止**が報告されており導入が不確実となった。

## Decision

**PayPay for Developers / 楽天ペイ API連携で設計を進める。**

- 対価性のある取引（商取引）として決済プロバイダに申請する
- 申請時には、研修・グッズ等のサービス/商品提供であることを明示する

## Consequences

### メリット
- 決済フローを自社で制御できる
- 複数決済（PayPay/楽天ペイ）を統一UIで提供できる
- 流入元トラッキングや金額の調整が柔軟
- 商取引として規約に適合する

### デメリット
- 開発・運用コストが増える（API連携・インフラ構築）
- 署名検証やidempotencyなどセキュリティ実装が必須

### 経理上の扱い

| 項目 | 内容 |
|------|------|
| 勘定科目 | 売上高 |
| 対価 | 研修提供、グッズ提供、活動支援（対価性あり） |
| 消費税 | 課税対象（標準税率） |

### アーキテクチャ変更

**Before:**
```
QRコード → 既存HP → つながる募金 → PayPay決済
```

**After:**
```
QRコード → 既存HP → Cloud Run → PayPay/楽天ペイ → Webhook → Firestore
```

## Risks & Mitigations

| リスク | 対応策 |
|--------|--------|
| Webhook偽装 | 署名検証 + IP制限 + 監視 |
| 決済の再送/重複 | idempotency設計 |
| 運用負荷増加 | 監視/アラートの自動化 |

## Alternatives

### 1. つながる募金
- 新規受付停止が報告されており、導入が不確実

### 2. PayPay法人ビジネスアカウント直接契約
- UXは最良だが審査が厳格（対面調査あり）

### 3. コングラント
- 領収書自動発行など運用は優れるが月額コストが高い
- 将来的な移行候補として検討継続

## References

- [PayPay for Developers](https://paypay.ne.jp/store-online/)
- [楽天ペイ（オンライン決済）](https://checkout.rakuten.co.jp/biz/)
